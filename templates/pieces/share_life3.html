
{% extends 'base.html' %}
{% block css %}

<!-- 引入 layui.css -->
<link href="//unpkg.com/layui@2.8.0/dist/css/layui.css" rel="stylesheet">

<!-- 引入 layui.js -->
<script src="//unpkg.com/layui@2.8.0/dist/layui.js"></script>
    <style>

        .imgContainer div {
            position: relative;
            display: inline-block;
        }

        .imgContainer img {
            width: 200px;
            height: 200px;
            margin: 10px;
        }
        /* 每张图片的X删除按钮  通过定位来实现 */

        .imgContainer span {
            position: absolute;
            top: 5%;
            right: 5%;
            background-color: pink;
            padding: 1px;
            display: none;
            cursor: pointer;
        }
    </style>


{% endblock css %}

{% block content %}
<form class="layui-form" action="" id="form">
                  <div class="layui-form-item">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-block">
                      <input type="checkbox" name="like[write]" title="创作">
                      <input type="checkbox" name="like[read]" title="阅读" >
                      <input type="checkbox" name="like[happy]" title="快乐" >
                      <input type="checkbox" name="like[dai]" title="发呆">
                      <input type="checkbox" name="like[emo]" title="emo">
                    </div>
                  </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">附加文案</label>
                    <div class="layui-input-block">
                        <textarea type="text"  name="copy" id="copy" required maxlength="512"  lay-verify="required"  autocomplete="off" class="layui-textarea"></textarea>
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">图片上传</label>
                    <div class="layui-input-block">
                        <div class="layui-upload">
                            <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;padding:10px 0 10px 0; ">
                              <div class="imgContainer" id="img_upload" ></div>
                           </blockquote>
                           <button type="button" class="layui-btn"  style="background-color:#4383d3" id="img_upload_btn">添加图片</button>
                        </div>
                        <button id="hideUpload" type="button" style="display: none"></button>
                    </div>
                </div>
                  <div class="layui-form-item">
                    <label class="layui-form-label">仅好友可见</label>
                    <div class="layui-input-block">
                      <input type="checkbox" name="switch" lay-skin="switch">
                    </div>
                  </div>
                  <div class="layui-form-item">
                    <label class="layui-form-label">@提醒谁来看</label>
                    <div class="layui-input-block">
                      <select name="city" lay-verify="required">
                        <option value=""></option>
                        <option value="0">北京</option>
                        <option value="1">上海</option>
                        <option value="2">广州</option>
                        <option value="3">深圳</option>
                        <option value="4">杭州</option>
                      </select>
                    </div>
                  </div>
                <div class="layui-form-item">
                    <div class="layui-input-special">
                    <button class="layui-btn" id="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary" id="reset" >重置</button>
                    </div>
                </div>
            </div>
            </form>
<script>
    window.onload=function(){

     //Demo
     layui.use(['form','upload','element','laydate'], function(){
            var form = layui.form;
            var $ = layui.jquery
            ,upload = layui.upload;
            //监听提交
                form.on('submit(formDemo)', function(data){
                var date = new Date();
                subData = {
                    copy:data.field.copy.toString(),
                }

                    $.ajax({
                        type:'post',
                        url:'/pieces/share_life/',
                        data:subData,
                        success:(res)=>{
                            if(res.code == 200){
                                alert('发布成功');
                            }else{
                                console.log(JSON.stringify(res).code);
                                console.log('res',res);
                                alert('发布失败');
                            }

                       },
                        error:(err)=>{
                            tip_text.innerHTML = '预约失败，请重新预约！';
                        }
                    });
                return false;
            });

            //多图片上传
            uploadInst=upload.render({
                elem: '#img_upload_btn'         //绑定点击按钮
                ,url: '/pieces/share_life/'     //访问后台路径
                ,multiple: true                 //确认上传多张图片
                ,accept: 'images/*'             //图片格式
                ,number: 6                      //最大上传图片数量
                ,auto:false                     //取消自动上传
                ,method: 'post'                 //请求上传的 http 类型
                ,bindAction:'#layui-btn'       //绑定真正的上传按钮
                ,data:{                         //访问后台提交的数据
                    copy:()=>{
                        return $('#copy').val();//官方文档说明：实现动态传值
                    },
                    time:()=>{
                        return subData.signup_time;
                    }

                }
                ,choose: function(obj){
                  //预读本地文件示例，不支持ie8
                  obj.preview(function(index, file, result){
                    $('#img_upload').append('<div><img src="'+ result +'" alt="'+ file.name +'" class="imgContainer"><span onClick="deleteOne(this)">X</span></div>');
                    // 鼠标经过图片所在盒子就显示左上角的X
                    $('.imgContainer div').on('mouseenter', function(e) {
                        $($(this)[0].children[1]).css('display', 'inline-block');
                    });
                    // 鼠标离开图片所在盒子就隐藏左上角的X
                    $('.imgContainer div').on('mouseleave', function(e) {
                        $($(this)[0].children[1]).css('display', 'none');
                    });

                  });
                    // 监听图片点击事件
                    $('.imgContainer div img').on('click', function() {
                        layer.open({
                            type: 4,
                            tips: 2, // 弹出层在下方
                            content: ['<img style="width:400px;height:400px" src="' + $(this)[0].src + '">', this],
                            shade: 0, // 不显示遮罩
                            area: ['450px', '430px'], // 设置宽高
                            time: 1000 // 1秒后自动隐藏弹出层
                        });

                });
                }
                ,done: function(res){
                  //上传完毕

                },
                error: function() {
                    //请求异常回调
                }
              });
        });
};
        // 删除单张照片
        function deleteOne(that) {
            uploadInst.config.elem.next()[0].value = '';
            $($(that)[0].parentNode)[0].innerHTML = '';
        }
</script>
{% endblock content %}

